---
name: aad-phase-pr
description: AAD v2 Phase 5 — PR作成フェーズ。state.jsonとreview-output.jsonを読み取り、gh CLIでDraft PRを作成し、pr-output.jsonを書き出す。
model: haiku
color: orange
allowed-tools: Bash, Read, Write
---

# AAD Phase: PR 作成 (Phase 5)

**IMPORTANT**: Always output responses in Japanese.

## 入力パラメータ

Task promptから以下を読み取る:

- `PROJECT_DIR`: プロジェクトディレクトリ（絶対パス）
- `INITIAL_REF`: 実装開始前のGit ref
- `RUN_ID`: 実行ID（例: 20240101-120000）
- `PARENT_BRANCH`: 親ブランチ名

## 実行ステップ

### Step 1: 情報収集

```bash
STATE_JSON="${PROJECT_DIR}/.claude/aad/state.json"
PLAN_JSON="${PROJECT_DIR}/.claude/aad/plan.json"
REVIEW_OUTPUT="${PROJECT_DIR}/.claude/aad/phases/review-output.json"

# state.json から統計取得
if command -v jq >/dev/null 2>&1; then
  WAVE_COUNT=$(jq '.completedLevels | length' "$STATE_JSON" 2>/dev/null || echo "?")
  AGENT_COUNT=$(jq '.tasks | length' "$STATE_JSON" 2>/dev/null || echo "?")
  FEATURE_TITLE=$(jq -r '.featureName // "implementation"' "$PLAN_JSON" 2>/dev/null || echo "implementation")
else
  WAVE_COUNT=$(python3 -c "import json; d=json.load(open('$STATE_JSON')); print(len(d.get('completedLevels', [])))" 2>/dev/null || echo "?")
  AGENT_COUNT=$(python3 -c "import json; d=json.load(open('$STATE_JSON')); print(len(d.get('tasks', {})))" 2>/dev/null || echo "?")
  FEATURE_TITLE=$(python3 -c "import json; d=json.load(open('$PLAN_JSON')); print(d.get('featureName', 'implementation'))" 2>/dev/null || echo "implementation")
fi

COMMIT_COUNT=$(git -C "$PROJECT_DIR" log --oneline "${INITIAL_REF}..HEAD" 2>/dev/null | wc -l | tr -d ' ')

# レビュー結果取得
REVIEW_SUMMARY="レビュー未実施"
if [ -f "$REVIEW_OUTPUT" ]; then
  if command -v jq >/dev/null 2>&1; then
    CRITICAL=$(jq '.critical // 0' "$REVIEW_OUTPUT" 2>/dev/null || echo "0")
    WARNING=$(jq '.warning // 0' "$REVIEW_OUTPUT" 2>/dev/null || echo "0")
  else
    CRITICAL=$(python3 -c "import json; d=json.load(open('$REVIEW_OUTPUT')); print(d.get('critical', 0))" 2>/dev/null || echo "0")
    WARNING=$(python3 -c "import json; d=json.load(open('$REVIEW_OUTPUT')); print(d.get('warning', 0))" 2>/dev/null || echo "0")
  fi
  REVIEW_SUMMARY="Critical: ${CRITICAL} | Warning: ${WARNING}"
fi
```

### Step 2: gh コマンド確認・remote 確認

```bash
# gh が使えない場合はスキップ
if ! command -v gh >/dev/null 2>&1; then
  echo "⚠ gh コマンドが見つかりません。PR作成をスキップします。"
  # pr-output.json をスキップ状態で書いて終了
  exit 0  # pr-output.json に skipped ステータスを書いてから終了
fi

# remote が存在しない場合はスキップ
if ! git -C "$PROJECT_DIR" remote get-url origin >/dev/null 2>&1; then
  echo "⚠ remote origin が見つかりません。PR作成をスキップします。"
  exit 0
fi
```

### Step 3: ブランチを push して PR 作成

```bash
git -C "$PROJECT_DIR" push -u origin "$PARENT_BRANCH" 2>/dev/null || true

PR_URL=$(gh pr create --draft \
  --title "feat: ${FEATURE_TITLE}" \
  --body "## 実装サマリー — AAD v2

### 統計
- Wave数: ${WAVE_COUNT}
- エージェント数: ${AGENT_COUNT}
- コミット数: ${COMMIT_COUNT}

### コードレビュー
${REVIEW_SUMMARY}

---
*Generated by /aad (aad-v2 ${RUN_ID})*" \
  2>/dev/null || echo "")
```

### Step 4: pr-output.json 書き出し

```bash
mkdir -p "${PROJECT_DIR}/.claude/aad/phases"
PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$' || echo "")
```

PR作成成功時:
```json
{
  "status": "completed",
  "prUrl": "{PR_URL}",
  "prNumber": {PR_NUMBER}
}
```

PR作成スキップ時:
```json
{
  "status": "skipped",
  "reason": "gh unavailable or no remote"
}
```

PR作成失敗時:
```json
{
  "status": "failed",
  "reason": "{error message}"
}
```

### Step 5: 結果表示

成功時:
```
## Phase 5: PR作成完了
Draft PR: {PR_URL}
```

スキップ時:
```
## Phase 5: PR作成スキップ (gh未利用可 or remote未設定)
```

## 制約

- gh が利用できない場合はスキップ（エラーにしない）
- remote が存在しない場合はスキップ（エラーにしない）
- pr-output.json は必ず書く（スキップ・失敗時も）
